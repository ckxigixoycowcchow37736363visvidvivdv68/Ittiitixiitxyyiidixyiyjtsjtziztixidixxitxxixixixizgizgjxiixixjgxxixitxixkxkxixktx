<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Sacred Box</title>
<style>
  body {font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:0; display:flex; flex-direction:column; align-items:center;}
  header {background:#6c5ce7;color:#fff;width:100%;padding:20px;text-align:center;font-size:2rem;font-weight:700;}
  .balance {margin-top:12px;font-size:1.1rem;font-weight:700;}
  .cards-container {display:flex;justify-content:center;flex-wrap:wrap;margin:30px;gap:20px;}
  .card {width:200px;height:300px;background:#fff;border-radius:12px;box-shadow:0 5px 15px rgba(0,0,0,0.1);display:flex;flex-direction:column;align-items:center;justify-content:space-between;padding:12px;transition:transform .2s}
  .card:hover{transform:scale(1.03)}
  .card img{width:100%;height:70%;object-fit:cover;border-radius:8px}
  .card button{background:#00b894;color:#fff;border:none;padding:8px;border-radius:8px;cursor:pointer;font-weight:700;width:100%}
</style>
</head>
<body>
<header>Sacred Box</header>
<div class="balance" id="balanceDisplay">Balance: ...</div>
<div class="cards-container" id="cardsContainer"></div>

<script>
const API_BASE = "https://0.0.0.0:5001"; // Replace with your server URL
const cards = [
  {name:"Golden Flower", price:50, img:"https://via.placeholder.com/200x200?text=Flower"},
  {name:"Lucky Cat", price:70, img:"https://via.placeholder.com/200x200?text=Cat"},
  {name:"Toy Car", price:40, img:"https://via.placeholder.com/200x200?text=Car"},
  {name:"Mystic Crystal", price:90, img:"https://via.placeholder.com/200x200?text=Crystal"},
  {name:"Magic Box", price:100, img:"https://via.placeholder.com/200x200?text=Box"}
];

const balanceDisplay = document.getElementById("balanceDisplay");
const container = document.getElementById("cardsContainer");
let userBalance = 0;
let user = null;
let initData = null;

// Initialize Telegram WebApp
if(window.Telegram?.WebApp){
  Telegram.WebApp.ready();
  const tUser = Telegram.WebApp.initDataUnsafe.user;
  user = tUser?.username || ("player_" + Math.floor(Math.random()*1000));
  initData = Telegram.WebApp.initData;
} else {
  user = localStorage.getItem("sacred_user") || prompt("Enter username:","player1");
  initData = "";
}
localStorage.setItem("sacred_user", user);

async function fetchBalance(){
  try{
    const res = await fetch(`${API_BASE}/balance?user=${encodeURIComponent(user)}&initData=${encodeURIComponent(initData)}`);
    const data = await res.json();
    if(data && typeof data.balance !== "undefined") userBalance = Number(data.balance);
    balanceDisplay.textContent = `Balance: ${userBalance} Coins`;
  } catch(err){
    console.error("Failed to fetch balance:", err);
    balanceDisplay.textContent = "Balance: 0 Coins";
    userBalance = 0;
  }
}

function renderCards(){
  container.innerHTML = "";
  const selected = cards.sort(()=>0.5-Math.random()).slice(0,3);
  selected.forEach(c=>{
    const el = document.createElement("div");
    el.className="card";
    el.innerHTML=`
      <img src="${c.img}" alt="${c.name}">
      <h3>${c.name}</h3>
      <p>Price: ${c.price} Coins</p>
      <button data-name="${c.name}" data-price="${c.price}">Buy</button>
    `;
    container.appendChild(el);
  });
  container.querySelectorAll("button").forEach(btn=>{
    btn.addEventListener("click", ()=>buyCard(btn.dataset.name, Number(btn.dataset.price)));
  });
}

async function buyCard(name, price){
  if(userBalance < price){
    alert("Not enough Coins!");
    return;
  }
  userBalance -= price;
  balanceDisplay.textContent = `Balance: ${userBalance} Coins`;
  alert(`You bought ${name} for ${price} Coins!`);

  try{
    const res = await fetch(`${API_BASE}/update_balance`, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({user:user, balance:userBalance, initData:initData})
    });
    const data = await res.json();
    if(!res.ok) console.warn("Server update failed:", data);
  } catch(err){
    console.error("Error updating server:", err);
    alert("Warning: Cannot reach server, changes are local only.");
  }
}

fetchBalance().then(()=>renderCards());
setInterval(renderCards, 10000);
</script>
</body>
</html>
